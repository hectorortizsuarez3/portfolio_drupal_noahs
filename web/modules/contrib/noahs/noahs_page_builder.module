<?php

/**
 * @file
 */

use Drupal\node\NodeInterface;
use Drupal\Core\Cache\RefinableCacheableDependencyInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\views\Views;
use Drupal\Core\Url;
use Drupal\noahs_page_builder\Controller\NoahsController;
use Drupal\noahs_page_builder\Fonts;
use Drupal\block\Entity\Block;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Render\Markup;


$moduleHandler = \Drupal::service('module_handler');

define('NOAHS_PAGE_BUILDER_PATH', \Drupal::service('extension.list.module')->getPath('noahs_page_builder'));
if ($moduleHandler->moduleExists('noahs_page_builder_pro')) {
  define('NOAHS_PAGE_BUILDER_PRO_PATH', \Drupal::service('extension.list.module')->getPath('noahs_page_builder_pro'));
}
else {
  define('NOAHS_PAGE_BUILDER_PRO_PATH', '');
}
define('NOAHS_PAGE_BUILDER_CSS_PATH', 'public://noahs/noahs_settings');
define('NOAHS_PAGE_BUILDER_JS_PATH', 'public://noahs/js');

/**
 * Implements hook_form_alter().
 */
function noahs_page_builder_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  $noahs_page_builder_config = \Drupal::config('noahs_page_builder.settings');
  $route = \Drupal::routeMatch()->getRouteName();
  $route_match = \Drupal::routeMatch();
  $node = $route_match->getParameter('node');
  $use_in_ctype = $noahs_page_builder_config->get('use_in_ctype');

  if ($route === 'quick_node_clone.node.quick_clone' ||
    $route === 'entity.node.content_translation_add') {
    foreach ($use_in_ctype as $type) {
      if (!is_numeric($type)) {
        if ($form_id === 'node_' . $type . '_quick_node_clone_form'
        || $form_id === 'node_' . $type . '_form') {

          $form_state->set('noahs_page_builder_original_nid', $node->id());
          $form_state->set('noahs_page_builder_lancgode', $node->get('langcode')->value);
          $form_state->set('noahs_page_builder_type', $node->getEntityTypeId());
          $form['actions']['submit']['#submit'][] = 'noahs_page_builder_clone_submit';
        }
      }
    }
  }
}


/**
 * Clone functions.
 *
 * @param array $form
 *   The form.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function noahs_page_builder_clone_submit($form, FormStateInterface $form_state) {

  $clone_page = \Drupal::classResolver(NoahsController::class)->clonePage(
    $form_state->get('noahs_page_builder_original_nid'),
    $form_state->get('nid'),
    $form_state->get('noahs_page_builder_lancgode'),
    $form_state->get('langcode'),
    $form_state->get('noahs_page_builder_type'),
  );

  \Drupal::messenger()->addMessage('New Noahs Page Added');
}

/**
 * Implements hook_theme_suggestions_page_alter().
 */
function noahs_page_builder_theme_suggestions_page_alter(array &$suggestions, array $variables) {

  $route = \Drupal::routeMatch()->getRouteName();
  if (strpos($route, ".canonical") !== FALSE) {
    $suggestions[] = 'page__noahs__front';
  }
}

/**
 * Implements hook_theme_suggestions_status_messages_alter().
 */
function noahs_page_builder_theme_suggestions_status_messages_alter(array &$suggestions, array $variables) {
  $route = \Drupal::routeMatch();
  $suggestions[] = 'status_messages__noahs';
}

/**
 * Implements hook_preprocess_html_alter().
 */
function noahs_page_builder_preprocess_html(array &$vars) {

  $route = \Drupal::routeMatch()->getRouteName();
  $route_match = \Drupal::routeMatch();

  $quote_menu_paths = [
    'noahs_page_builder.editor',
    'noahs_page_builder_pro.iframe',
    'noahs_page_builder_pro.build',
  ];

  if (in_array($route, $quote_menu_paths)) {
    $vars['attributes']['class'][] = 'noahs_page_builder-editor-active';
  }
  // Get the current path.
  $current_path = \Drupal::service('path.current')->getPath();
  $internal = \Drupal::service('path_alias.manager')->getAliasByPath($current_path);

  // Assign it to body class.
  $vars['attributes']['class'][] = str_replace("/", "", $internal);
}


function noahs_page_builder_preprocess_noahs_menu_block(array &$variables) {

}

/**
 * Implements hook_preprocess_menu().
 * Inyecta data-* en $variables['attributes'] para lectura en menu.html.twig.
 */
function noahs_page_builder_preprocess_menu(array &$variables) {


  // Recoger flags desde render array (prefijo '#' o sin él) o variables del bloque.
  $responsive_flag = !empty($variables['attributes']['data-responsive']) ? $variables['attributes']['data-responsive'][0] : NULL;
  $orientation_flag = !empty($variables['attributes']['data-orientation']) ? $variables['attributes']['data-orientation'][0] : NULL;
  $collapsible_flag = !empty($variables['attributes']['data-collapsible']) ? $variables['attributes']['data-collapsible'][0] : NULL;
  $vertical_expand_flag = !empty($variables['attributes']['data-vertical-expand']) ? $variables['attributes']['data-vertical-expand'][0] : NULL;
  $normal_menu_flag = !empty($variables['attributes']['data-normal-menu']) ? $variables['attributes']['data-normal-menu'][0] : NULL;


  // Definir atributos sólo si hay valor (para evitar data- vacíos).
  if (!empty($responsive_flag)) {
    // Valor estándar esperado en Twig: noahs-menu--responsive.
    $variables['noahs_menu_responsive'] = $responsive_flag;
  }
  if (!empty($orientation_flag)) {
    $variables['noahs_menu_orientation'] = $orientation_flag;
  }
  if (!empty($collapsible_flag)) {
    $variables['noahs_menu_collapsible'] = $collapsible_flag;
  }
  if (!empty($vertical_expand_flag)) {
    $variables['noahs_menu_vertical_expand'] = $vertical_expand_flag;
  }
  if (!empty($normal_menu_flag)) {
    $variables['noahs_menu_normal'] = $normal_menu_flag;
  }

}

/**
 * Implements hook_theme().
 */
function noahs_page_builder_theme($existing, $type, $theme, $path) {
  return [
    'noahs-settings-form' => [
      'variables' => [
        'content' => '',
        'iframe_url' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs-settings-iframe' => [
      'variables' => [
        'widget' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs-admin-form' => [
      'variables' => [
        'page' => '',
        'content' => '',
        'noahs_id' => '',
        'langcode' => '',
        'entity_type' => '',
        'url' => '',
        'widgets' => [],
        'globlal_widgets' => [],
        'defaults_widgets' => [],
        'page_settings' => [],
        'render_form' => '',
        'iframe_url' => '',
        'noahs_pro' => '',
        'noahs_ai' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs-admin-preview' => [
      'variables' => [
        'page' => '',
        'content' => '',
        'page_settings' => [],
        'generated_html' => '',
        'noahs_id' => '',
        'type' => '',
        'entity_type' => '',
        'langcode' => '',
        'widgets' => '',
        'noahs_pro' => '',
        'noahs_ai' => '',
        'logo' => '/' . NOAHS_PAGE_BUILDER_PATH . '/assets/img/logo.svg',
      ],
      'path' => $path . '/templates/backend',
    ],
    'html__product_preview__noahs_page_builder' => [
      'template' => 'html--preview--noahs',
      'base hook' => 'html',
      'path' => $path . '/templates/backend',
    ],
    'html__admin__structure__noahs__settings_styles' => [
      'template' => 'html--noahs-settings-styles',
      'base hook' => 'html',
      'path' => $path . '/templates/backend',
    ],
    'html__admin__structure__noahs__settings_iframe' => [
      'template' => 'html--noahs-settings-iframe',
      'base hook' => 'html',
      'path' => $path . '/templates/backend',
    ],
    'html__preview__noahs_page_builder' => [
      'template' => 'html--preview--noahs',
      'base hook' => 'html',
      'path' => $path . '/templates/backend',
    ],
    'html__noahs_edit' => [
      'template' => 'html--noahs-edit',
      'base hook' => 'html',
      'path' => $path . '/templates/backend',
    ],
    'page__admin__structure__noahs__settings_styles' => [
      'template' => 'page--noahs-settings-styles',
      'base hook' => 'page',
      'path' => $path . '/templates/backend',
    ],
    'page__admin__structure__noahs__settings_iframe' => [
      'template' => 'page--noahs-settings-iframe',
      'base hook' => 'page',
      'path' => $path . '/templates/backend',
    ],
    'page__preview__noahs_page_builder' => [
      'template' => 'page--preview--noahs',
      'base hook' => 'page',
      'path' => $path . '/templates/backend',
    ],
    'page__noahs_edit' => [
      'template' => 'page--noahs-edit',
      'base hook' => 'page',
      'path' => $path . '/templates/backend',
    ],
    'page__noahs_edit__preview' => [
      'template' => 'page--noahs-edit-preview',
      'base hook' => 'page',
      'path' => $path . '/templates/backend',
    ],
    'noahs-admin-edit-widget' => [
      'variables' => [
        'page' => '',
        'content' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs_icons_list' => [
      'variables' => [
        'content' => '',
        'icons' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs_media_modal_page' => [
      'template' => 'noahs--media-modal-page',
      'variables' => [
        'data' => [],
        'element_id' => '',
        'view_render' => '',
        'type' => '',
        'wid' => '',
        'source' => '',
      ],
      'path' => $path . '/templates/backend',
    ],
    'noahs_menu_local_tasks' => [
      'variables' => ['primary' => [], 'secondary' => []],
    ],
    'noahs_social_networks' => [
      'variables' => [
        'icon_text' => '',
        'socials' => [],
      ],
      'path' => $path . '/templates/blocks',
    ],
    'noahs_media_swiper' => [
      'variables' => [
        'attributes' => NULL,
        'slides' => [],
      ],
      'path' => $path . '/templates/fields',
    ],
    'views_noahs_media_swiper' => [
      'variables' => [
        'attributes' => NULL,
        'rows' => [],
      ],
    ],
    'noahs_menu_block' => [
      'variables' => [
        'menu' => [],
        'noahs_menu_responsive' => '',
        'noahs_menu_orientation' => '',
      ],
      'path' => $path . '/templates/frontend/noahs-menu',
      'template' => 'noahs-menu-block',
    ],
    'noahs_gallery' => [
      'variables' => [
        'attributes' => NULL,
        'columns' => 3,
        'items' => [],
      ],
      'path' => $path . '/templates/fields',
    ],
  ];
}

/**
 * Implements hook_entity_delete().
 */
function noahs_page_builder_entity_delete(EntityInterface $entity) {
  $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $entity_type = $entity->getEntityTypeId();
  $entity_id = $entity->id();

  // Usar correctamente \Drupal::database() si estás fuera de clase.
  $builder = \Drupal::database()->select('noahs_page_builder_page', 'd')
    ->fields('d', ['entity_id'])
    ->condition('entity_id', $entity_id)
    ->condition('entity_type', $entity_type)
    ->condition('langcode', $langcode)
    ->execute()
    ->fetchAssoc();

  if ($builder != NULL) {
    \Drupal::database()->delete('noahs_page_builder_page')
      ->condition('entity_type', $entity_type)
      ->condition('entity_id', $entity_id)
      ->condition('langcode', $langcode)
      ->execute();

    \Drupal::messenger()->addMessage('Noahs Page Removed');
  }
}

/**
 * Share variables.
 *
 * @return array
 *   The variables.
 */
function sharePageVariables() {
  $variables = \Drupal::request()->attributes->get('_noahs_page_builder_preprocessed_variables', []);
  return $variables;
}

/**
 * Check user in route.
 *
 * @return bool
 *   The user.
 */
function noahsCheckUser() {

  $current_user = \Drupal::currentUser();
  if ($current_user->isAuthenticated()) {
    return TRUE;
  }
}

/**
 * Implements hook_preprocess_page().
 */
function noahs_page_builder_preprocess_page(&$variables) {

  \Drupal::request()->attributes->set('_noahs_page_builder_preprocessed_variables', $variables);
  $noahs_page_builder_config = \Drupal::config('noahs_page_builder.settings');
  $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $pallete_color = [];
  $variables_color = [];

  $viewPortTablet = !empty($noahs_page_builder_config->get('viewport_tablet')) ? $noahs_page_builder_config->get('viewport_tablet') : '959';
  $viewPortMobile = !empty($noahs_page_builder_config->get('viewport_mobile')) ? $noahs_page_builder_config->get('viewport_mobile') : '767';

  $pallete_color[] = !empty($noahs_page_builder_config->get('principal_color')) ? $noahs_page_builder_config->get('principal_color') : '#2389ab';
  $pallete_color[] = !empty($noahs_page_builder_config->get('secondary_color')) ? $noahs_page_builder_config->get('secondary_color') : '#4a4a4a';

  $custom_colors = $noahs_page_builder_config->get('custom_color') ?? [];

  foreach ($custom_colors as $color) {
    if (!empty($color['hex'])) {
      $pallete_color[] = $color['hex'];
      $k = str_replace('#', '', $color['hex']);
      $variables_color['--noahs_page_builder-' . $k] = $color['hex'];
    }
  }

  $variables_color['--noahs_page_builder-principal-color'] = !empty($noahs_page_builder_config->get('principal_color')) ? $noahs_page_builder_config->get('principal_color') : '#2389ab';
  $variables_color['--noahs_page_builder-secondary-color'] = !empty($noahs_page_builder_config->get('secondary_color')) ? $noahs_page_builder_config->get('secondary_color') : '#4a4a4a';

  $variables['#attached']['drupalSettings']['noahs_page_builder']['pallete_color'] = $pallete_color;
  $variables['#attached']['drupalSettings']['noahs_page_builder']['variables_color'] = $variables_color;
  $variables['#attached']['drupalSettings']['noahs_page_builder']['viewport_tablet'] = $viewPortTablet;
  $variables['#attached']['drupalSettings']['noahs_page_builder']['viewport_mobile'] = $viewPortMobile;

  $route = \Drupal::routeMatch()->getRouteName();

  $route_match = \Drupal::routeMatch();
  $classes = [];
  $attributes = [];
  $moduleHandler = \Drupal::service('module_handler');

  $variables['#attached']['drupalSettings']['noahs_page_builder']['check_user'] = noahsCheckUser();
  $variables['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder.noahs_admin';
  $active_theme = \Drupal::theme()->getActiveTheme()->getName();
  $defaultThemeName = \Drupal::config('system.theme')->get('default');

  $rutas_para_mostrar = [
    'noahs_page_builder.editor',
    'noahs_page_builder_pro.build',
    'noahs_popups.build',
    'noahs_page_builder.noahs_settings_styles',
  ];
  
  if (in_array($route, $rutas_para_mostrar)) {
    $variables['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder.jquery_ui';
  }


  $entity = NULL;
  if ($route === 'entity.commerce_product.canonical') {
    $entity = $route_match->getParameter('commerce_product');
    $entity_id = 'product_' . !empty($entity) ? $entity->id() : '';
  }
  elseif ($route === 'entity.taxonomy_term.canonical') {
    $entity = $route_match->getParameter('taxonomy_term');
    $entity_id = 'term_' . !empty($entity) ? $entity->id() : '';
  }
  else {
    $entity = $route_match->getParameter('node');
    $entity_id =  !empty($entity) ? $entity->id() : NULL;
  }
  if ($entity && $entity_id) {
    $data = noahs_page_builder_load($langcode, $entity_id, $entity->getEntityTypeId()) ?? NULL;
    $sections = noahs_page_builder_get_sections($data->settings);
    $page_settings = !empty($data->page_settings) ? json_decode($data->page_settings, TRUE) : [];
    $classes[] = \Drupal::classResolver(NoahsController::class)->getClasses($data, 'class');
    $attributes[] = \Drupal::classResolver(NoahsController::class)->getClasses($data, 'attributes');
    $variables['#attached']['drupalSettings']['noahs_page_builder']['classes'][] = $classes;
    $variables['#attached']['drupalSettings']['noahs_page_builder']['attributes'][] = $attributes;
    $variables['noahs_entity_html'] = noahs_page_builder_html_generated($sections);
  }
  if (
    $active_theme === $defaultThemeName &&
    $route != 'noahs_page_builder.editor' &&
    $route != 'noahs_page_builder_pro.build' &&
    $route != 'noahs_popups.build' &&
    $route != 'noahs_page_builder.noahs_settings_styles'
  ) {

    $variables['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder.assets.init_front';
    $variables['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder.assets.frontend';
  }
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function noahs_page_builder_menu_local_tasks_alter(&$data, $route_name, RefinableCacheableDependencyInterface &$cacheability) {
  $route_match = \Drupal::routeMatch();

  $config = \Drupal::config('noahs_page_builder.settings');
  $use_in_ctype = $config->get('use_in_ctype') ?: [];
  $use_in_vtype = $config->get('use_in_vtype') ?: [];
  $use_in_products = $config->get('use_in_products') ?: [];

  if (in_array($route_name, ['entity.node.canonical', 'entity.node.edit_form'])) {
    $node = $route_match->getParameter('node');
    if (array_key_exists($node->bundle(), $use_in_ctype) && $node->bundle() === $use_in_ctype[$node->bundle()]) {

      $data['tabs'][0]['node.edit_noahs'] = [
        '#theme' => 'menu_local_task',
        '#link' => [
          'title' => t('Edit With Noahs'),
          'url' => Url::fromRoute('noahs_page_builder.editor', ['entity_type' => 'node', 'entity' => $node->id()]),
          'weight' => 10,
          'localized_options' => [
            'attributes' => [
              'title' => t('Add content'),
            ],
          ],
        ],
      ];

    }
  }

  if (in_array($route_name, ['entity.taxonomy_term.edit_form', 'entity.taxonomy_term.canonical'])) {
    $term = $route_match->getParameter('taxonomy_term');
    if (array_key_exists($term->bundle(), $use_in_vtype) && $term->bundle() === $use_in_vtype[$term->bundle()]) {

      $data['tabs'][0]['term.edit_noahs'] = [
        '#theme' => 'menu_local_task',
        '#link' => [
          'title' => t('Edit With Noahs'),
          'url' => Url::fromRoute('noahs_page_builder.editor', ['entity_type' => 'taxonomy_term', 'entity' => $term->id()]),
          'weight' => 10,
          'localized_options' => [
            'attributes' => [
              'title' => t('Add content'),
            ],
          ],
        ],
      ];

    }
  }

  $product = $route_match->getParameter('commerce_product');
  if (!empty($product)) {

    if (array_key_exists($product->bundle(), $use_in_products) && $product->bundle() === $use_in_products[$product->bundle()]) {

      $data['tabs'][0]['term.edit_noahs'] = [
        '#theme' => 'menu_local_task',
        '#link' => [
          'title' => t('Edit With Noahs'),
          'url' => Url::fromRoute('noahs_page_builder.editor', ['entity_type' => 'commerce_product', 'entity' => $product->id()]),
          'weight' => 10,
          'localized_options' => [
            'attributes' => [
              'title' => t('Add content'),
            ],
          ],
        ],
      ];
    }
  }

}

/**
 * Implements hook_help().
 */
function noahs_page_builder_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.noahs_page_builder':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Best frontend editor on drupal 10+.') . '</p>';
      return $output;
  }
}

/**
 * Get noahs sections.
 *
 * @param string $html
 *   The html.
 *
 * @return array
 *   The sections.
 */
function noahs_page_builder_get_sections($html) {

  if ($html) {
    $content = json_decode($html);
    return $content;
  }
}

/**
 * Render noahs elements.
 *
 * @param object $el_settings
 *   The element settings.
 * @param string $content
 *   The content.
 *
 * @return string
 *   The rendered element.
 */
function noahs_page_builder_render_element($el_settings, $content = '') {

  $widgetService = \Drupal::service('noahs_page_builder.widget_service');
  $type = $el_settings->type;
  $widget = $widgetService->loadWidgetById($type);

  if ($widget) {
    return $widget->renderContent($el_settings, $content);
  }

}

/**
 * Generate noahs html.
 *
 * @param array $sections
 *   The sections.
 *
 * @return string
 *   The html.
 */
function noahs_page_builder_html_generated($sections) {
  $html = '';
  if ($sections) {
    foreach ($sections as $key => $section) {
      $widget_id = $section->type;
      $html .= print_widgets($section);
    }
  }

  return $html;
}

/**
 * Generate noahs structure.
 *
 * @param object $widget
 *   The widget.
 *
 * @return string
 *   The html.
 */
function print_widgets($widget) {

  $content = '';
  $columns = $widget->columns;

  if (!empty($columns)) {
    foreach ($columns as $ckey => $column) {
      $elements = $column->elements;
      // Reset $element_content for each column.
      $element_content = '';

      if (!empty($elements)) {
        foreach ($elements as $ekey => $element) {

          if ($element->type === 'noahs_row') {
            $output_element = print_widgets($element);
            $element_content .= $output_element;
          }
          else {

            if (!empty($element->global)) {
              if (is_module_installed('noahs_page_builder_pro')) {
                $global_widget = noahs_page_builder_pro_load_global_widget($element->wid);
                $element->settings = json_decode($global_widget->settings);
              }
            }

            $html_element = noahs_page_builder_render_element($element);

            if (!empty($html_element)) {
              $html_element_sin_tabs = preg_replace('/\t/', '', $html_element);
              $output_element = $html_element_sin_tabs;
              $element_content .= $output_element;
            }
          }
        }
      }

      $column_settings_json = $column->settings;
      $html = noahs_page_builder_render_element($column, $element_content);
      $html_sin_tabs = preg_replace('/\t/', '', $html);
      $output = $html_sin_tabs;
      $content .= $output;
    }
  }

  $html = noahs_page_builder_render_element($widget, $content);
  $html_sin_tabs = preg_replace('/\t/', '', $html);
  $output = $html_sin_tabs;

  return $output;
}

/**
 * Load Noahs Builder.
 *
 * @param string $langcode
 *   The language code.
 * @param int $noahs_id
 *   The noahs id.
 * @param string $entity_type
 *
 * @return object
 *   The page.
 */
function noahs_page_builder_load($langcode, $noahs_id, $entity_type) {

  $result = \Drupal::database()->select('{noahs_page_builder_page}', 'd')
    ->fields('d')
    ->condition('noahs_id', $noahs_id, '=')
    ->condition('entity_type', $entity_type)
    ->condition('langcode', $langcode)
    ->execute()
    ->fetchObject();
  $page = new stdClass();
  if ($result) {
    $page->entity_id = $result->entity_id;
    $page->noahs_id = $result->noahs_id;
    $page->uid = $result->uid;
    $page->settings = $result->settings;
    $page->page_settings = $result->page_settings;
    $page->langcode = $result->langcode;
    $page->entity_type = $result->entity_type;
    $page->modified_date = $result->modified_date;
    $page->page_id = $result->page_id;
  }
  else {
    $page->settings = [];
  }

  return $page;
}

/**
 * Get Drupal Blocks.
 *
 * @return array
 *   The blocks.
 */
function noahs_page_builder_load_blocks() {

  $block_manager = \Drupal::service('plugin.manager.block');
  $blocks = Block::loadMultiple();

  $definitions = $block_manager->getDefinitionsForContexts();
  $block_options = [];

  foreach ($definitions as $plugin_id => $definition) {
    $block_label = $definition['admin_label'] ?? $plugin_id;
    $block_options[$plugin_id] = $block_label;
  }
  foreach ($blocks as $plugin_id => $definition) {
    $block_label = $definition->get('settings')['label'] . ' (Theme)';
    $block_options[$plugin_id] = $block_label;
  }
  return $block_options;
}

/**
 * Get drupal views.
 *
 * @return array
 *   The views.
 */
function noahs_page_builder_load_views() {
  $getViews = Views::getViewsAsOptions(TRUE, 'all', NULL, FALSE, TRUE);

  $viewsData = \Drupal::service('views.views_data');
  $views = [];
  foreach ($getViews as $key => $view_name_master) {
    $view = Views::getView($key);

    foreach ($view->storage->get('display') as $name_id => $display_id) {

      if ($display_id['display_plugin'] == 'block') {
        $views[$key][] = [
          'view_id' => $key,
          'block_id' => htmlspecialchars(json_encode([$key, $name_id]), ENT_QUOTES, 'UTF-8'),
          'text' => $display_id['display_title'],
          'master' => $view_name_master,
        ];
      }
    }
  }

  return $views;
}

/**
 * Implements hook_library_info_alter().
 */
function noahs_page_builder_library_info_alter(array &$libraries, $extension) {


  $route_match = \Drupal::routeMatch();
  $route = $route_match->getRouteName();

  $active_theme = \Drupal::theme()->getActiveTheme()->getName();
  $default_theme = \Drupal::config('system.theme')->get('default');



  // 2. CSS general de configuración si estamos en el tema por defecto
  if ($active_theme === $default_theme) {
    if ($route !== 'noahs_page_builder.noahs_settings_styles') {
      $general_css = noahs_page_builder_add_node_css('noahs_settings', 'noahs_settings');
      if (!empty($general_css)) {
        $libraries['noahs_page_builder_dynamic_css']['css']['theme'][$general_css] = ['weight' => 9999];
      }
    }

    // 3. Archivo general_settings.css si existe
    $settings_path = NOAHS_PAGE_BUILDER_CSS_PATH . '/general_settings.css';
    if (file_exists($settings_path)) {
      $file_url = \Drupal::service('file_url_generator')->generateAbsoluteString($settings_path);
      $libraries['noahs_page_builder_dynamic_css']['css']['theme'][$file_url] = ['weight' => 9999];
    }
    
    // 4. Archivo noahs_custom.js si existe
    $noahs_custom_js_path = NOAHS_PAGE_BUILDER_JS_PATH . '/noahs_custom.js';
    if (file_exists($noahs_custom_js_path)) {
      $js_file_url = \Drupal::service('file_url_generator')->generateAbsoluteString($noahs_custom_js_path);
      $libraries['noahs_page_builder_dynamic_js']['js'][$js_file_url] = [];

    }
  }
  if ($route === 'noahs_page_builder.noahs_settings_iframe') {
    $settings_path = NOAHS_PAGE_BUILDER_CSS_PATH . '/general_settings.css';
    if (file_exists($settings_path)) {
      $file_url = \Drupal::service('file_url_generator')->generateAbsoluteString($settings_path);
      $libraries['noahs_page_builder_dynamic_css']['css']['theme'][$file_url] = ['weight' => 9999];
    }
  }
}

/**
 * Implements hook_page_attachments().
 */
function noahs_page_builder_page_attachments(array &$page) {
  $route = \Drupal::routeMatch()->getRouteName();

  if ($route != 'noahs_page_builder.editor' && $route != 'noahs_page_builder_pro.build' && $route != 'noahs_page_builder.noahs_settings_styles') {
    $page['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder_dynamic_css';
    $page['#attached']['library'][] = 'noahs_page_builder/noahs_page_builder_dynamic_js';
  }

}

/**
 * Implements hook_page_attachments_alter().
 */
function noahs_page_builder_page_attachments_alter(array &$attachments) {
  $fonts_css = noahs_page_builder_add_font_css() ?? [];

  foreach ($fonts_css as $i => $font_css) {
    $attachments['#attached']['html_head'][] = [
      $font_css,
      'noahs_page_builder_font_' . $i, // identificador único
    ];
  }
}

/**
 * Add fonts css.
 */
function noahs_page_builder_add_font_css() {

  $noahs_page_builder_config = \Drupal::config('noahs_page_builder.settings');
  $customFonts = $noahs_page_builder_config->get('custom_fonts') ?? [];


  $availableFonts = Fonts::getFontsAvailables();
  $customFrontsArray = [];
  foreach ($customFonts as $font) {
    if (!empty($font['name'])) {
      $customFrontsArray[] = $font['name'];
    }
  }

  $element = [];

  foreach ($availableFonts as $i => $font) {

    $font_folder = '/' . NOAHS_PAGE_BUILDER_PATH . '/assets/css/noahs-fonts/' . str_replace(' ', '_', strtolower($font)) . '.css';
    $font_file_url = \Drupal::service('file_url_generator')->transformRelative($font_folder);
    if (in_array($font, $customFrontsArray)) {
      continue;
    }
    $element['font_' . $i] = [
      '#type' => 'html_tag',
      '#tag' => 'link',
      '#attributes' => [
        'rel' => 'stylesheet',
        'href' => $font_file_url,
      ],
    ];
  }

  return $element;
}

/**
 * Add page css.
 *
 * @param string $entity_type
 *   The entity type.
 * @param int $id
 *   The id.
 *
 * @return string
 *   The css.
 */
function noahs_page_builder_add_node_css($entity_type, $id) {

  $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $default_language = \Drupal::languageManager()->getDefaultLanguage();
  $default_language_code = $default_language->getId();
  $config = \Drupal::config('noahs_page_builder.settings');

  if (!empty($id)) {
    if ($entity_type === 'noahs_settings') {
      $css_file_name = 'settings.css';
    }
    else {
      $css_file_name = 'noahs_' . $id . '_' . $langcode . '.css';
    }

    if ($entity_type === 'pro_theme') {
      $css_file_name = 'noahs_' . $id . '_' . $default_language_code . '.css';
    }

    if (file_exists('public://noahs/' . $entity_type . '/' . $css_file_name)) {

      $file_uri = 'public://noahs/' . $entity_type . '/' . $css_file_name;
      $file_url = \Drupal::service('file_url_generator')->generateAbsoluteString($file_uri);

      if (!empty($config->get('develop_mode'))) {
        $file_url .= '?' . time();
      }

      return $file_url;
    }
  }
}

/**
 * Get entity ID from context.
 *
 * @param string $parameter
 *   The parameter.
 *
 * @return string
 *   The entity id.
 */
function getEntityid($parameter) {
  $route_match = \Drupal::routeMatch();
  if (!empty($route_match->getParameter($parameter))) {
    return $route_match->getParameter($parameter);
  }
  else {
    return 'noEntityId';
  }
}

/**
 * Implements hook_preprocess_HOOK() for block templates.
 */
function noahs_page_builder_preprocess_block(array &$variables) {

  $block = $variables['elements']['#configuration'];


  if ($block['id'] === 'page_title_block') {

    $current_path = \Drupal::service('path.current')->getPath();
    $route_match = \Drupal::service('current_route_match');
    $route_name = $route_match->getRouteName();


    $rutas_para_ocultar = [
      'noahs_page_builder.editor',
      'noahs_page_builder.preview',
      'noahs_page_builder_pro.iframe',
      'noahs_page_builder_pro.build',
      'noahs_popups.iframe',
      'noahs_popups.build',
    ];

    if (in_array($route_name, $rutas_para_ocultar)) {
      $variables['elements']['#access'] = FALSE;
      $variables['#access'] = FALSE;
    }
  }
  
  $block = Block::load($variables['elements']['#id']);
  if ($block) {
    $tag = $block->getThirdPartySetting('noahs_page_builder', 'title_tag', '') ?? NULL;
    $blockClasses = $block->getThirdPartySetting('noahs_page_builder', 'block_classes', '') ?? NULL;
    if (!empty($tag)) {
      $variables['label'] = NULL;
      $allowed = ['h1','h2','h3','h4','h5','h6','div','p','span'];
      $classes = '';
      $block_title_classes = $block->getThirdPartySetting('noahs_page_builder', 'block_title_classes', '') ?? NULL;
      if (!empty($block_title_classes)) {
        $classes = ' class="' . $block_title_classes . '"';
      }
      $variables['content']['custom_title'] = [
        '#markup' => '<' . $tag . $classes . '>' . $block->label() . '</' . $tag . '>',
        '#allowed_tags' => $allowed,
        '#weight' => -10,
      ];
    }
    $variables['attributes']['class'] = $variables['attributes']['class'] ?? [];

    if (!empty($blockClasses)) {
      $variables['attributes']['class'] = array_merge(
        $variables['attributes']['class'],
        preg_split('/\s+/', trim($blockClasses))
      );
    }
  }


}

/**
 * Implements hook_block_access().
 */
function noahs_page_builder_block_access(Block $block, $operation, AccountInterface $account) {
  $blockAccess = TRUE;

  if ($block->getPluginId() === 'page_title_block') {
    // Obtiene la ruta actual.
    $current_path = \Drupal::service('path.current')->getPath();
    $route_match = \Drupal::service('current_route_match');
    $route_name = $route_match->getRouteName();

    // Rutas donde quieres ocultar el bloque.
    $rutas_para_ocultar = [
      'noahs_page_builder.editor',
      'noahs_page_builder.preview',
      'noahs_page_builder_pro.iframe',
      'noahs_page_builder_pro.build',
      'noahs_popups.iframe',
      'noahs_popups.build',
    ];
    // Oculta el bloque si la ruta actual está en la lista.
    if (in_array($route_name, $rutas_para_ocultar)) {

      $blockAccess = FALSE;
      return AccessResult::forbiddenIf($blockAccess == FALSE)->addCacheableDependency($block);
    }
  }

  return AccessResult::neutral();

}

/**
 * Check if module is installer.
 *
 * @param string $module
 *   The module.
 *
 * @return bool
 *   The module installed.
 */
function is_module_installed($module) {
  // Obtener el servicio del manejador de módulos.
  $module_handler = \Drupal::service('module_handler');

  // Verificar si el módulo Commerce está instalado.
  return $module_handler->moduleExists($module);
}


/**
 * Implements hook_noahs_widgetbase_allowed_routes_alter().
 */

function noahs_page_builder_noahs_widgetbase_allowed_routes_alter(&$allowed_routes) {
  $allowed_routes[] = 'noahs_page_builder.preview';
  $allowed_routes[] = 'noahs_page_builder.widget';
  $allowed_routes[] = 'noahs_page_builder.noahs_settings';
  $allowed_routes[] = 'noahs_page_builder.themes_get_default';
  $allowed_routes[] = 'noahs_page_builder.product_preview';
  $allowed_routes[] = 'noahs_page_builder.final_widget';
  $allowed_routes[] = 'noahs_page_builder.regenerate_widget';
}



/**
 * Implements hook_form_BASE_FORM_ID_alter() for block_form.
 */
function noahs_page_builder_form_block_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $form_object = $form_state->getFormObject();
  if (!$form_object || !method_exists($form_object, 'getEntity')) {
    return;
  }

  // Intentar obtener la entidad Block (puede ser NULL para plugin-only).
  $entity = $form_object->getEntity();
  // Intentar obtener la instancia del plugin si la entidad la expone.
  $plugin = NULL;
  if ($entity && method_exists($entity, 'getPlugin')) {
    $plugin = $entity->getPlugin();
  }
  // Si no hay entidad, intentar obtener configuración de plugin (fallback).
  $plugin_conf = $plugin ? $plugin->getConfiguration() : [];

  // Build el panel "Noahs options".
  $options = [
    '' => t('- Default -'),
    'h1' => 'h1', 'h2' => 'h2', 'h3' => 'h3', 'h4' => 'h4', 'h5' => 'h5', 'h6' => 'h6',
    'div' => 'div', 'p' => 'p', 'span' => 'span',
  ];

  $form['noahs_page_builder'] = [
    '#type' => 'details',
    '#title' => t('Noahs options'),
    '#open' => FALSE,
    '#weight' => 90,
  ];

  // Valores comunes -> preferimos third party settings en la entidad, si existe,
  // si no, tomamos del plugin configuration.
  $title_tag_default = '';
  $block_title_classes_default = '';
  $block_classes_default = '';

  if ($entity instanceof Block) {
    $title_tag_default = $entity->getThirdPartySetting('noahs_page_builder', 'title_tag', '');
    $block_title_classes_default = $entity->getThirdPartySetting('noahs_page_builder', 'block_title_classes', '');
    $block_classes_default = $entity->getThirdPartySetting('noahs_page_builder', 'block_classes', '');
  }
  else {
    $title_tag_default = $plugin_conf['title_tag'] ?? '';
    $block_title_classes_default = $plugin_conf['block_title_classes'] ?? '';
    $block_classes_default = $plugin_conf['block_classes'] ?? '';
  }

  $form['noahs_page_builder']['title_tag'] = [
    '#type' => 'select',
    '#title' => t('Title type'),
    '#description' => t('Choose the HTML tag used to render this block title.'),
    '#options' => $options,
    '#default_value' => $title_tag_default,
  ];
  $form['noahs_page_builder']['block_title_classes'] = [
    '#type' => 'textfield',
    '#title' => t('Title Class'),
    '#description' => t('Custom classes to add to the block title (separate with spaces).'),
    '#default_value' => $block_title_classes_default,
  ];
  $form['noahs_page_builder']['block_classes'] = [
    '#type' => 'textfield',
    '#title' => t('Block Class'),
    '#description' => t('Custom classes to add to the block wrapper (separate with spaces).'),
    '#default_value' => $block_classes_default,
  ];

  // Si el plugin es un menu system (puede venir como system_menu_block:footer),
  // comprobamos que el plugin id comience por 'system_menu_block'.
  $is_system_menu_block = FALSE;
  if ($plugin instanceof BlockPluginInterface) {
    $plugin_id = $plugin->getPluginId();
    if (strpos($plugin_id, 'system_menu_block') === 0) {
      $is_system_menu_block = TRUE;
    }
  }
  else {
    // Fallback: si no tenemos la instancia plugin, comprobar configuración del form
    // (en algunos contextos el plugin puede venir por $form['#base_plugin_id']).
    $form_base = $form['#base_plugin_id'] ?? $form['#plugin_id'] ?? '';
    if (strpos((string)$form_base, 'system_menu_block') === 0) {
      $is_system_menu_block = TRUE;
    }
  }

  // Prepend nuestro submit para ejecutar antes del guardado core.
  if (isset($form['actions']['submit']['#submit']) && is_array($form['actions']['submit']['#submit'])) {
    array_unshift($form['actions']['submit']['#submit'], 'noahs_page_builder_block_form_submit');
  }
  else {
    $form['actions']['submit']['#submit'][] = 'noahs_page_builder_block_form_submit';
  }
}

/**
 * Submit handler to persist third-party settings on blocks.
 */
function noahs_page_builder_block_form_submit(array &$form, FormStateInterface $form_state) {
  $form_object = $form_state->getFormObject();
  if (!$form_object || !method_exists($form_object, 'getEntity')) {
    return;
  }

  $entity = $form_object->getEntity();
  $values = $form_state->getValues();

  // Valores de nuestro detalle.
  $title_tag = $values['noahs_page_builder']['title_tag'] ?? '';
  $block_title_classes = $values['noahs_page_builder']['block_title_classes'] ?? '';
  $block_classes = $values['noahs_page_builder']['block_classes'] ?? '';


  // Si existe la entidad Block -> guardamos third party settings.
  if ($entity instanceof Block) {
    $entity->setThirdPartySetting('noahs_page_builder', 'title_tag', $title_tag);
    $entity->setThirdPartySetting('noahs_page_builder', 'block_title_classes', $block_title_classes);
    $entity->setThirdPartySetting('noahs_page_builder', 'block_classes', $block_classes);

    // Guardar explícitamente para forzar persistencia si nuestro submit corre después del core.
    try {
      $entity->save();
    }
    catch (\Exception $e) {
      // No interrumpir la petición por un error de guardado.
    }
  }
  else {
    // No hay entidad -> plugin-only. Guardamos dentro de la configuración del plugin
    // para que core la registre. Recuperamos settings actuales y los actualizamos.
    $settings = $form_state->getValue('settings') ?? [];

    // Además conservamos los campos de noahs_page_builder dentro de la configuración del plugin
    // por si quieres que se guarden ahí para plugin-only (fallback).
    $settings['title_tag'] = $title_tag;
    $settings['block_title_classes'] = $block_title_classes;
    $settings['block_classes'] = $block_classes;

    // Setear de nuevo 'settings' en form_state para que core lo procese y lo guarde en la configuración del plugin.
    $form_state->setValue('settings', $settings);
  }
}

